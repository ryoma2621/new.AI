name: Daily Dify Workflow (JST 06:00)

on:
  schedule:
    - cron: '0 21 * * *'   # JST 06:00
  workflow_dispatch:

concurrency:
  group: daily-dify-run
  cancel-in-progress: true

jobs:
  run-dify-workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call Dify /v1/workflows/run
        id: start
        env:
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}
          DIFY_API_KEY:  ${{ secrets.DIFY_API_KEY }}
        run: |
          set -euo pipefail
          HTTP_CODE=$(curl -sS -X POST "$DIFY_API_BASE/v1/workflows/run" \
            -H "Authorization: Bearer $DIFY_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"inputs":{},"response_mode":"blocking","user":"news-cron"}' \
            -w '%{http_code}' -o dify_resp.json)
          echo "HTTP_CODE=$HTTP_CODE"
          cat dify_resp.json
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error title=DifyRequestFailed::HTTP code $HTTP_CODE"
            exit 1
          fi
          # JSON内にerrorがあるかチェック
          ERR=$(jq -r '.error // empty' dify_resp.json)
          if [ -n "$ERR" ]; then
            echo "::error title=DifyErrorField::error => $ERR"
            exit 1
          fi
          RUN_ID=$(jq -r '.workflow_run_id // empty' dify_resp.json)
          if [ -z "$RUN_ID" ]; then
            echo "::error title=MissingRunID::No workflow_run_id in response"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          echo "Started workflow_run_id=$RUN_ID"

      - name: Poll until Dify completes
        env:
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}
          DIFY_API_KEY:  ${{ secrets.DIFY_API_KEY }}
          RUN_ID:        ${{ steps.start.outputs.run_id }}
        run: |
          set -euo pipefail
          for i in $(seq 1 12); do
            RESP=$(curl -sS "$DIFY_API_BASE/v1/workflows/run/$RUN_ID" \
              -H "Authorization: Bearer $DIFY_API_KEY")
            STATUS=$(jq -r '.status // empty' <<< "$RESP")
            echo "[$(date -u +%T)] status=$STATUS"
            if [ "$STATUS" = "succeeded" ] || [ "$STATUS" = "partial-succeeded" ]; then
              break
            elif [ "$STATUS" = "failed" ] || [ "$STATUS" = "stopped" ]; then
              echo "::error title=DifyWorkflowFailed::status= $STATUS"
              echo "$RESP"
              exit 1
            fi
            sleep 10
          done

      - name: Log summary and send LINE
        env:
          RUN_ID:        ${{ steps.start.outputs.run_id }}
        run: |
          set -euo pipefail
          RESP=$(curl -sS -H "Authorization: Bearer ${{ secrets.DIFY_API_KEY }}" \
            "${{ secrets.DIFY_API_BASE }}/v1/workflows/run/${RUN_ID}")
          COUNT=$(jq -r '.outputs.summary.count // 0' <<< "$RESP")
          LAST=$(jq -r '.outputs.summary.last_title // "UNKNOWN"' <<< "$RESP")
          echo "::notice title=DailyNewsSummary::件数=${COUNT}, 最終タイトル=${LAST}"
          # 送信条件をここでもチェック
          if [ "$COUNT" -eq 0 ] || [ "$LAST" = "UNKNOWN" ]; then
            echo "::error title=InvalidSummary::件数=${COUNT}, 最終タイトル=${LAST}"
            exit 1
          fi
          # ここに LINE 配信用の curl POST コマンドなどを入れる
