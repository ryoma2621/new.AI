name: Daily Dify Workflow (JST 06:00)

on:
  schedule:
    - cron: '0 21 * * *'    # JST 06:00（Actions の cron は UTC 固定）
  workflow_dispatch:        # 手動実行したい時に使う

# 同時二重起動を自動キャンセル
concurrency:
  group: daily-dify-run
  cancel-in-progress: true

jobs:
  run-dify-workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
      - name: Call Dify /v1/workflows/run (streaming, no-retry)
        env:
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}  # 例: https://api.dify.ai
          DIFY_API_KEY:  ${{ secrets.DIFY_API_KEY }}   # 対象アプリの Backend API Key
        run: |
          set -euo pipefail

          # POST は非冪等。1回だけ叩く（--retry は付けない）
          # streaming は Cloudflare のタイムアウト回避に有効
          HTTP_CODE=$(curl -sS -X POST "$DIFY_API_BASE/v1/workflows/run" \
            -H "Authorization: Bearer $DIFY_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"inputs":{},"response_mode":"streaming","user":"news-cron"}' \
            -o response.sse \
            -w '%{http_code}')

          echo "HTTP_CODE=$HTTP_CODE"
          # 200 なら OK（SSE なので本文は response.sse に保存）
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Dify accepted request in streaming mode."
            # 任意: 軽く待ってから終了（念のため）
            sleep 3
            exit 0
          fi

          # 5xx は“ソフトエラー”として扱う（Dify 側は動いてLINEが届くケースがある）
          if [ "${HTTP_CODE:0:1}" = "5" ]; then
            echo "Warning: upstream returned $HTTP_CODE, but Dify may still be running. Marking job success to avoid duplicate runs."
            exit 0
          fi

          # それ以外（4xx など）は失敗扱い
          echo "Error: unexpected HTTP $HTTP_CODE from Dify."
          echo "---- response head ----"
          head -c 200 response.sse || true
          exit 1
